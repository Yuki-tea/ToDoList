FROM node:24-alpine
WORKDIR /app

# 1. ビルド引数を定義（デフォルト値は1000にしておく）
ARG UID=1000
ARG GID=1000

# 2. ユーザーIDを書き換えるためのツール(shadow)をインストール
RUN apk add --no-cache shadow

# 3. 既存の 'node' ユーザーのUID/GIDを、ホストから受け取った値に書き換える
#    (もし値が同じでもエラーにならないよう || true をつけるか、純粋に実行する)
RUN groupmod -g "${GID}" node && \
    usermod -u "${UID}" -g "${GID}" node

# 4. 作業ディレクトリの所有権を変更したユーザー(node)に設定
RUN chown -R node:node /app

# 5. ユーザーを切り替え
USER node

# 6. 依存関係のインストール（nodeユーザーとして実行される）
COPY --chown=node:node package*.json ./
RUN npm ci

# 7. ソースコードのコピー
COPY --chown=node:node . .

CMD ["npm", "run", "start:dev"]
